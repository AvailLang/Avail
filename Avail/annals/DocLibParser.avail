/*
 * DocLibParser.avail
 * Copyright © 1993-2013, Mark van Gulik and Todd L Smith.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 *
 * * Redistributions in binary form must reproduce the above copyright notice,
 *   this list of conditions and the following disclaimer in the documentation
 *   and/or other materials provided with the distribution.
 *
 * * Neither the name of the copyright holder nor the names of the contributors
 *   may be used to endorse or promote products derived from this software
 *   without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */

System Module "DocLibParser"
Versions
	"Dev"
Extends

Uses
	"Avail"
Names
	"document",
	"method document",
	"parameter document",
	"return document"

Body

Public explicit class "document" extends object
	with fields
		$name : string,
		$description : string;

Public class "parameter document" extends document
	with fields
		$parameter : type;

Public class "return document" extends document
with fields
	$returnType : type;

Public class "method document" extends document
	with fields
		$returns : return document,
		$parameters : <parameter document…|>,
		$moduleName : string,
		reconstructible $hasSemanticRestriction : boolean,
		reconstructible $semanticRestrictionModules : <string…|>,
		reconstructible $section : string
	with reconstructors
		(parameters, returns);


/**
 * Takes the parameters of a method from a parameter document object 
 * and generates html for display on a webpage.
 *
 * Parameters:
 *    params - a tuple of objects of type parameter document
 * Returns:
 *    an html string that formats the parameter 
 */
Method "convert_to html" is
[
 	params : <parameter document…|>
 |
 	output : string := "<b>Parameters:</b><br />\n" ++
	 	"<ol class=\"BodyDescription\">\n";
 	For each params do [
 		p : parameter document
	 |
	 	output := eject ↑output ++ "<li>" ++ p's name ++ " : " ++
	 		“p's parameter” ++ " - " ++
	 		“p's description” ++ "</li>\n";
	];
 	output ++ "</ol>\n"
] : string;

/**
 * Takes the return type of a method from a return document object and 
 * generates html for display on a webpage.
 *
 * Parameters:
 *    rType - an object of type return document
 * Returns:
 *    an html string that formats the return type 
 */
Method "convert_to html" is
[
	rType : return document
 |
	"<b>Returns:</b><br>\n" ++
		"<p class=\"BodyDescription\">\n" ++
 		“rType's returnType” ++ " - " ++
 		rType's description ++ "</p>\n" ++ "</section>"
] : string;

/**
 * Takes a method document object and generates html for display on a webpage.
 *
 * Parameters:
 *    mDoc - an object of type method document
 * Returns:
 *    an html string that formats the method for the description section of the
 *    html page.
 */
Method "generate html for method description section of_" is
[
	mDoc : method document
 |
 	output : string := "<hr />\n" ++ "<p id=\"" ++ mDoc's name ++ "\">\n" ++
 		"<strong class=\"FunctionHead\">" ++ mDoc's name ++ "</strong><br />\n"
		++ "<section class=\"BodyDescription\">\n" ++  mDoc's description ++
		"<br /><br />\n";
 
	output := output ++ convert mDoc's parameters to html;
	output ++ convert mDoc's returns to html
] : string;

/**
 * Takes a method document object and generates html for a link on 
 * a webpage.
 *
 * Parameters:
 *    mDocs - an object of type method document
 * Returns:
 *    an html string that formats the method as a link for navigation  
 *    on the html page.
 */
Method "generate html method link from_" is
[
	mDoc : method document
|
	"<a href=\"#" ++ mDoc's name ++ "\">" ++ mDoc's name ++ "</a><br />\n"
] : string;

/**
 * Takes a tuple of method document objects and generates html for links on 
 * a webpage.
 *
 * Parameters:
 *    mDocs - a tuple of objects of type method document
 * Returns:
 *    an html string that formats the method for links creating a navigation  
 *    bar for the method description section of the html page.
 */
Method "generate html navigation bar for methods from_" is
[
	mDocs : <method document…|1..>
|
	navBar : string := "<aside class=\"MethodList\">\n" ++ 
		"<h1 class=\"SpecialHeading\">Methods</h1>\n" ++
		"<nav class=\"OverFlowScroll\">\n";

	For each mDocs do
	[
	 	mDoc : method document
	 |
	 	navBar := navBar ++ generate html method link from mDoc;
	];

	navBar ++ "</nav>\n" ++ "</aside>\n"
] : string;

/**
 * Takes a tuple of method document objects and generates html for display on 
 * a webpage.
 *
 * Parameters:
 *    mDocs - a tuple of objects of type method document
 * Returns:
 *    an html string that formats the methods for the method navigation bar and 
 *    the description section of the html page.
 */
Method "generate html for methods page from_" is
[
	mDocs : <method document…|1..>
|
	methodNavBar : string := 
		generate html navigation bar for methods from mDocs;
	outputDescriptions : string := "<h2 class=\"SpecialHeading\">" ++ 
		mDocs[1]'s moduleName ++ "</h2>\n" ++ 
		"<section class=\"MethodDescription\">";
	
	For each mDocs do 
	[
	 	mDoc : method document
	 |
	 	outputDescriptions := outputDescriptions ++ 
	 		generate html for method description section of mDoc;
	];

	methodNavBar ++ outputDescriptions ++ "</section>\n" ++ "</body>"
] : string;

/**
 * Takes a module name and generate an html string for a navigation link on 
 * a webpage.
 *
 * Parameters:
 *    string - a tuple of objects of type method document
 * Returns:
 *    a string of html that is a link to an html page.
 */
Method "generate html for an alternate page link from_" is
[
	pageName : string
|
	"<a href=\"" ++ pageName ++ ".html\">" ++ pageName ++ "</a><br />"
]: string;

/**
 * Takes a map of module names to of method document objects and generates html 
 * links for display on a webpage.
 *
 * Parameters:
 *    mDocsMap - a map of objects of type method document with string keys
 * Returns:
 *    an html string that enables navigation between joined pages 
 */
Method "generate html for modules section from_" is
[
	mDocsMap : {string→<method document…|1..>|1..}
|
	modulesSection : string := "<nav class=\"ModuleList\">";
	
	For each mDocsMap's keys do 
	[
	 	modName : string
	 |
	 	modulesSection := modulesSection ++ 
	 		generate html for an alternate page link from modName;
	];

	modulesSection ++ "</nav>"
] : string;

/**
 * Takes a map of module names to of method document objects and generates html 
 * links for many linked webpages.
 *
 * Parameters:
 *    mDocsMap - a map of objects of type method document with string keys
 * Returns:
 *    an html string of joined method documentation pages 
 */
Method "generate html for joined pages from_" is
[
	mDocsMap : {string→<method document…|1..>|1..}
 |
	standardTopHTML : string := "<!DOCTYPE html>\n" ++ 
			"<html lang=\"en\">\n" ++ 
			"	<head>\n" ++ 
			"		<link href=\"doclib.css\" rel=\"stylesheet\" />\n" ++ 
			"		<meta charset=\"UTF-8\">\n";

	finalOutputHTML : string := "";
	
	For each mDocsMap do 
	[
	 	key : string,
		value : <method document…|1..>
	 |
	 	finalOutputHTML := finalOutputHTML ++ standardTopHTML ++ 
	 		"<title>" ++ key ++ "</title>\n" ++ "</head>\n" ++ "<body>\n" ++
	 		"<h1 class=\"MainHeading\">AVAIL</h1>\n" ++ 
	 		"<h2 class=\"SpecialHeading\">Modules</h2>\n" ++
	 		generate html for modules section from mDocsMap ++ 
	 		generate html for methods page from value ++ "\n\n";
	];

	finalOutputHTML
] : string;

p1 : parameter document := a parameter document with
$name ::= "param1",
$description ::= "I'm a this!",
$parameter ::= whole number;

p2 : parameter document := a parameter document with
$name ::= "param2",
$description ::= "I'm a that!",
$parameter ::= string;


r1 : return document := a return document with
$name ::= "return1",
$description ::= "Take what I give you!",
$returnType ::= whole number;

r2 : return document := a return document with
$name ::= "return2",
$description ::= "You ain't get shit!",
$returnType ::= ⊤;

m1 : method document := a method document with
$name ::= "Strings_times_",
$description ::= "What I do is a secret, shhhhh...",
$returns ::= r1,
$parameters ::= <p1,p2>,
$moduleName ::= "Nonsense",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

m2 : method document := a method document with
$name ::= "HeHe_",
$description ::= "What I do is a secret, shhhhh...",
$returns ::= r1,
$parameters ::= <p1>,
$moduleName ::= "Nonsense",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

m3 : method document := a method document with
$name ::= "Stuff_Whoops_",
$description ::= "Break Stuff!",
$returns ::= r2,
$parameters ::= <p2,p1>,
$moduleName ::= "Nonsense",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

m4 : method document := a method document with
$name ::= "Jump_",
$description ::= "Kaboom!...",
$returns ::= r2,
$parameters ::= <p2>,
$moduleName ::= "Nonsense",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

n4 : method document := a method document with
$name ::= "Strings_times_",
$description ::= "What I do is a secret, shhhhh...",
$returns ::= r1,
$parameters ::= <p1,p2>,
$moduleName ::= "Pickles",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

n3 : method document := a method document with
$name ::= "HeHe_",
$description ::= "What I do is a secret, shhhhh...",
$returns ::= r1,
$parameters ::= <p1>,
$moduleName ::= "Pickles",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

n2 : method document := a method document with
$name ::= "Stuff_Whoops_",
$description ::= "Break Stuff!",
$returns ::= r2,
$parameters ::= <p2,p1>,
$moduleName ::= "Pickles",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

n1 : method document := a method document with
$name ::= "Jump_",
$description ::= "Kaboom!...",
$returns ::= r2,
$parameters ::= <p2>,
$moduleName ::= "Pickles",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

o3 : method document := a method document with
$name ::= "Strings_times_",
$description ::= "What I do is a secret, shhhhh...",
$returns ::= r1,
$parameters ::= <p1,p2>,
$moduleName ::= "Bunnies",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

o4 : method document := a method document with
$name ::= "HeHe_",
$description ::= "What I do is a secret, shhhhh...",
$returns ::= r1,
$parameters ::= <p1>,
$moduleName ::= "Bunnies",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

o1 : method document := a method document with
$name ::= "Stuff_Whoops_",
$description ::= "Break Stuff!",
$returns ::= r2,
$parameters ::= <p2,p1>,
$moduleName ::= "Bunnies",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

o2 : method document := a method document with
$name ::= "Jump_",
$description ::= "Kaboom!...",
$returns ::= r2,
$parameters ::= <p2>,
$moduleName ::= "Bunnies",
$hasSemanticRestriction ::= false,
$semanticRestrictionModules ::= <>,
$section ::= "Test";

methodDocuments ::= <m1,m2,m3,m4,n1,n2,n3,n4,o1,o2,o3,o4>;

aMap ::= group methodDocuments by [md : method document | md's moduleName];

